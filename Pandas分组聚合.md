## 摘要

本文主要基于[Pandas User Guide: Group By](https://pandas.pydata.org/docs/user_guide/groupby.html)整理，包含的关键技巧有：
- `groupby()`方法的参数，主要是`by`、`level`、`as_index`、`dropna`.
- 对聚合对象的`describe()`描述性统计.
- 统一聚合函数`aggregation()`及命名聚合Named Aggregation.
- 统一窗口函数`transform()`.

---
## 基本概念

分组聚合group by操作是将数据框（或Series）按照某些准则分组，对每个组应用固定的函数，最后将结果合并成一个新的数据结构的过程. 对每个分组可能执行的函数包括：
- 聚合：函数为每个组计算一个汇总统计量.
- 转换：函数为组里的每个样本计算一个基于分组的值.
- 过滤：函数按照一定准则舍弃一些组.

## 分割(Splitting)

分组操作提供一个标签到组名的映射，这一步骤不执行任何运算或拆分，GroupBy对象仅仅提供一个样本到索引的映射. 用`groupby()`方法创建一个GroupBy对象，其`groups`属性是一个组名到组标签的映射，`indices`是一个组名到组索引的映射，`get_group()`方法可以基于组名得到子组数据框.

对普通数据框，`by`参数指定分组准则，可以接受下面的类型作为聚合键：
- 函数：对对象的index执行的函数，用函数值作为分组依据.
- 字典或Series：用它们的值作为分组依据，Series会先与数据框对齐.
- 等长数组：直接用数组的值作为分组依据.
- 列名字符串：传入`str`等同于传入`df[str]`，与等长数组（或Series）效果一致.
- 列表：传入上述对象的列表，将其他对象计算得到的值组合成元组.

对于多重索引的数据框，用`level`参数指定聚合的索引层级. `level`参数能够接受的取值有：
- 整数索引：聚合索引的层级，`0`为最外层，数值越大越内层.
- 索引名字符串：如果MultiIndex有指定名字，则字符串也可以表示索引层级.
- 列表：传入上述对象的列表，构成索引层级列表.

一般说来，`by`和`level`参数不能同时指定，但如果一定要同时对列与索引层级同时聚合，可以使用`pd.Grouper()`创建的对象，可以在此函数中使用`level`参数，达成与在`groupby()`中直接指定`level`参数一样的目的. 不过，如果MultiIndex本身是命名的，也可以直接以索引名字符串的形式传入`by`参数列表中.

`groupby()`方法默认会对聚合键进行排序，可以用`sort`参数控制聚合键是否排序，如果设置为`False`就不会对聚合键进行排序，这可以加快`groupby()`的速度. 另外，`groupby()`在每个组内会保持每个样本的出现顺序. 

`groupby()`方法默认会排除值为`NA`的聚合键，可以用`dropna`参数控制`NA`聚合键是否会被舍弃，如果设置为`False`则所有`NA`聚合键会被视为一组.

`groupby()`方法得到的结果默认会把聚合键设定为GroupBy对象的Index，如果想要像SQL风格的输出，将聚合键仍然保持在数据框里，可以将参数`as_index`设置为`False`.

最后，一个GroupBy对象是一个迭代器，每一个迭代单位是`(name, group)`，其中`name`是组内聚合键的值，`group`是组内样本构成的子数据框. 此外，一个基于数据框的GroupBy对象可以用列名提取出一个Series，这个Series也是一个GroupBy对象，分组准则与父数据框一致.

## 聚合(Aggregation)

#### 简单单功能聚合

对GroupBy对象执行的聚合操作，指的是为每个组执行能够得到常量的运算，是一种维度减少的操作. 内置的聚合操作有
- `all()/any()`：若组中(所有/任一)值是真值对象，则返回`True`.
- `size()`：返回组行数Series，与计数功能无关.
- `count()/nunique()`：返回(非去重/去重)非空值计数.
- `first()/last()/nth(n)`：返回(第一个/最后一个/第n个)值.
- `max()/min()/quantile(q)`：返回(最大值/最小值/q分位数).
- `idxmax()/idxmin()`：返回(最大值/最小值)的索引.
- `mean()/median()`：返回组内(均值/中位数).
- `var()/std()/sem()`：返回组内(方差/标准差/均值标准误).
- `sum()/prod()`：返回(累加/累乘).

`describe()`也起到聚合的作用，它可以方便地返回每个组每个列的描述性统计信息. `value_counts()`也起到聚合的作用，它返回每个组内各种值的计数情况. 上述两个函数都将一整个组作为输入，但产生的结果不视为一个常量，不称它们为聚合函数.

#### 复杂聚合

如果不满足于对GroupBy对象执行单一的操作，那么应当使用`aggregation()`方法或其缩写`agg()`方法，此方法尤其适合Pandas自带的方法不能满足需求、需要编写用户自定义函数(UDF)时. 用户自定义函数可以用`def`声明命名函数，也可以用`lambda`声明匿名函数，它们以一个序列`series`作为输入并返回常数结果. 在`agg()`中可以以函数字符串的形式输入Pandas内置的GroupBy聚合函数.

`agg()`方法可以接受单个函数，但这种情况主要应用于Series的GroupBy对象，即只有一列. 如果是一个DataFrame的GroupBy对象，则在执行完`groupby()`后要用`[col]`选择函数应用的单列，返回的结果也只有`col`这一列.

想一次性执行多种聚合操作时，可以向`agg()`中传入一个列表作为参数，列表中的每一项是一个函数或函数字符串. 输出的结果中每一列的列名是传入的函数名，而如果是对一个DataFrame的GroupBy对象应用（而非Series的），则外层名字索引是GroupBy对象的原有列名，内层名字索引是`agg()`中的函数名.

更多时候，分组聚合会对每个列执行不同的操作，并且要控制输出的列名称，称这种行为为命名聚合，向`agg()`函数以`**kwargs`形式传入键值对. 这时`kwargs`的键为要输出的列名，值为一个二元组`(column, aggfunc)`，可以简单传入一个这种形式的二元组，也可以用`pd.NamedAgg()`函数创建一个含有`column`与`aggfunc`域的命名元组. 此方法可以简化，只需传入一个真正的字典作为参数，其键为列名，值为函数或函数列表.

## 转换(Transformation)

对GroupBy对象执行的转换操作，指的是为每个组执行不减少样本量的函数，即为每一个样本生成一个值，但这个值依赖于分组的定义. 称这样的函数为窗口函数，在Pandas中，窗口函数往往是为了给原有数据框增加一个新的列. 内置的窗口函数有
- `ngroup()`：标识组号.
- `cumcount()/rank(method)`：(编号/排名)，其中`method`指定并列排名方式.
- `cummax()/cummin()`：累计(最大值/最小值).
- `cumsum()/cumprod()`：累计(求和/求积).
- `ffill()/bfill()`：(前向/后向)填充缺失值.
- `shift(period)`：向后推移一定数量的行.
- `diff()`：返回组内差分，即后项减前项.
- `pct_change()`：返回组内变化百分比，即后项减前项的差除以前项.

如果想要把分组聚合的结果连接到组里的每一个样本上以便执行算术运算，不需要先执行聚合函数再执行表连接，只需要用`transform()`方法传入聚合函数即可，对内置的聚合函数可以简单传入函数字符串.

`transform()`方法执行窗口函数功能，与`agg()`方法对应，也可以接受UDF，不过UDF返回的结果必须可以广播到整个组，即产生与原组相同大小的列表或单值. 常用的自定义函数有：组内标准化、组内`max-min`变换、缺失值填充、组内极差计算等.

## 过滤(filtration)

过滤操作根据一定规则对输出的GroupBy结果进行筛选，可以分为两类，一类是根据一定条件筛选出一些组，另一类是根据一定条件筛选出每个组内一些样本.

对于筛选组内样本的过滤，典型过滤方法是
- `head(n)`：返回每个组开头n行.
- `tail(n)`：返回每个组最后n行.
- `nth(n)`：返回每个组第n行.

对于筛选整个组的过滤，一般通过`filter()`方法定义UDF，这里的UDF是一个Bool函数，返回的值是`True`或者`False`. `filter()`函数会返回经过UDF运算后，结果为`True`的组，也可以设定参数`dropna`为`False`，让结果为`False`的组以`NA`的形式出现在结果数据框，而不是直接删除.

复杂的转换一般要通过直接对聚合得到的结果数据框进行运算，得到筛选的Bool数组. 这种行为与直接筛选数据框的记录无异.

## 其他

### Apply函数

如果应用于组的某些操作可能不是聚合、转换或过滤，那么可以使用`apply()`方法执行更灵活的聚合运算. 该方法接受一个用户自定义函数，它以分组数据框作为输入，可能是任何形式的输出，最后将结果聚合为一个数据框返回.

### 用户自定义函数(UDF)

在`aggregation()`、`transform()`、`filter()`、`apply()`四个方法中都可以接受用户自定义函数(UDF)，编写这些自定义函数时要注意，不能改变输入本身，即函数不能是inplace执行的. 如果确实有些函数需要用到inplace操作，应当建立一个副本.

### 小技巧

- 简单聚合函数可以指定`numeric_only=True`参数，限定只对数值列使用.
- 关于分类值聚合时，如果数据框中不含某个分类（未观测），可以给`by`参数传入一个`pd.Categorical()`分组器并指定`observed`参数为`False`. 关于分组器，
	- `pd.Categorical()`的第一个参数是和待聚合数据框等长的分类数组.
	- `pd.Categorical()`第二个参数`categories`是包含的所有分类构成的列表.
	- 如果`groupby()`中指定`sort`为`True`，则`categories`参数视为有序因子.
- 关于时间聚合时，可以用`pd.Grouper()`分组器指定`freq`参数提供精细控制.
- `cumcount()`窗口函数类似SQL的`row_number()`，进行组内编号.
- 对`groupby()`对象可以直接用画图函数，提供基于分组聚合的可视化.