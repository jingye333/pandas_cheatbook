## 摘要

本文基于[Pandas User Guide: Indexing](https://pandas.pydata.org/docs/user_guide/indexing.html)和[Pandas User Guide: Advanced](https://pandas.pydata.org/docs/user_guide/advanced.html)总结而成. 包含的要点有：

## 简单索引

对于一个DataFrame，Pandas允许的索引方式有：方括号索引(`[col]`)、属性索引(`.col`)、切片索引(`[m:n]`)、标签索引(`.loc[]`)和位置索引(`.iloc[]`).

上面的方法中，常用的是用方括号索引来节选数据框的列，只需在`[]`中传入列名字符串或其构成的列表，就可按顺序得到对应Series或其构成的列表. 也可以在`[]`传入Bool数组，就可以得到对应的行数据. 但是这种方法仅推荐用于一维索引，而不推荐从行和列两个维度一起进行筛选. 如果要从行与列两个维度一起筛选，或者对原数据框进行修改，最好使用标签索引`.loc[]`和位置索引`.iloc[]`.

标签索引和位置索引依然使用中括号`[]`进行索引而非括号`()`，说明它们并非DataFrame的方法. 它们还具有以下特性：
- 如果只在`[]`传入单值，则会将对应行转化为Series返回，称为横截面.
- 如果在`[]`传入一个位置（没有逗号分隔）且为多值，则返回值所对应的行与所有列.
- 如果在`[]`传入两个位置（有逗号分隔），则返回值对应的行与列. 这种做法一般会用Bool数组索引行，然后`.loc[]`用列名索引列，`.iloc[]`用位置索引列.
- 如果需要筛选所有行与部分列，可以用`:`填充`[]`的第一个位置. 这一操作一般用于对DataFrame修改值.

使用标签索引时必须保证传入的标签在数据框的index中，在`.loc[]`中支持的输入有：
- 标签或其列表，支持字符串或者整数，但整数并不代表行的位置.
- 标签切片，如`df.loc['col_m':'col_n']`会取到`col_m`和`col_n`及其之间的所有行，包括端点.
- Bool Series，返回`True`对应的行.

位置索引完全用行在DataFrame中的位置进行索引. 在`.iloc[]`中支持的输入有：
- 整数或其列表，代表行位置而非索引.
- 切片，此时切片逻辑与Python的取数逻辑完全一致，只包含下限不包含上限.
- Bool Series，返回`True`对应的行.

最后，如果想要得到的只是单个标量值，而不需要保存Series结构或DataFrame结构，相比于用`.loc[]`和`.iloc[]`在两个位置上传入单值，更应该使用`.at[]`和`.iat[]`，它们分别以标签列名形式索引和以位置索引.

## Bool索引

### Bool Series

欲选择DataFrame的若干行，最常用的方式是使用Bool数组进行索引，传入一个与数据框共享index的Bool Series，以返回`True`所对应的行.

由于数据框与Bool Series需要共享index，往往Bool Series就是从DataFrame的一些列派生而成. 可以用逻辑运算符与`&`、或`|`、非`~`连接不同的Bool表达式，但每个条件必须使用括号包裹，也不用考虑运算符优先级.

除了使用比较运算符得到基础的Bool Series外，还可以使用Series的特定方法来返回Bool Series，如
- `s.map()`：传入一个函数，对Series的每一个值调用此函数得到一个Series.
- `s.isin()`：传入一个值列表，判断Series的每一个值是否在列表中.
- `s.isna()`：判断Series的每一个值是否为`NA`.

### where和mask

用Bool Series进行索引只会返回对应位置为`True`的子集，`False`位置会被舍弃，这将导致输出的结果与原DataFrame或Series形状不同. 如果希望保持输出结果的形状，则可以使用`where()`或`mask()`方法，它们不会舍弃元素，而是将`False`/`True`对应的位置设置为`NA`. 它们接受下面的参数：
- `cond`：Bool条件，可以是Series或DataFrame，只要能与原数据框对齐即可.
- `other`：填充值，替换`NA`，同样可以是能够对齐的Series或DataFrame.
- `axis`和`level`可以在需要的时候指定对齐的轴.

## 多重索引

应当将多重索引视为元组索引，元组的每一个位置代表索引的每一个层级，从前往后层级依次细化. 为了避免出现混淆，最好使用标签索引`.loc[]`的方式进行索引，索引依然用逗号分隔的两部分分别表示行列索引，每一个位置依然支持下面的输入：
- 单值，此时的单值是一个元组（多重索引）或者一个值（多重索引的一个层）.
- 列表，列表的每一个对象是一个单值.
- 切片，此时切片的端点可以是任意一种单值，依然包含两端.

这里值得注意的是，索引内部对元组和列表有不同的处理方式. 每一个多重index都由一个元组构成，因此列表内嵌套元组指的是多个并列的多重index；而元组内嵌套列表，则对应的是一个层级内的多个取值，元组内还可以包含`slice()`创建的切片，用于提供不连续的切片.

可以用`xs()`方法创建一个切面，即层次更低的DataFrame. `xs()`的第一个参数`key`指定索引，`level`参数指定索引所在的层级. `key`中指定的索引也可以是单字符串、字符串构成的列表（同一索引层级的不同值）、字符串构成的元组（不同索引层级）等. 如果不希望降低切面的层数，也可以指定参数`drop_level`为`False`.

如有需要，可以对多重索引的层级进行修改，下面是用到的两个方法，可以用`axis`指定轴.
- `swaplevel(m, n)`：交换`m`和`n`索引层级.
- `reorder_levels(lst)`：以`lst`的顺序旋转层级.

用`sort_index()`函数进行索引排序，`level`参数指定排序的层级，`axis`指定排序轴.

## 其他

### 重复值处理

Pandas默认将第一个观测到的值视为非重复的，但这种默认行为可以被修改. 有两个方法用于识别和处理重复值：
- `duplicated()`：返回一个Bool Series，指示行是否重复.
- `drop_duplicates()`：删除重复的行.

这两个函数接受的第一个参数均为要考虑重复现象的列名或列名列表，此外它们还接受`keep`参数指定如何识别重复值，可选取值有：
- `'first'`：即默认值，标识值的第一次出现，其余出现视为重复值.
- `'last'`：标识值的最后一次出现，其余出现视为重复值.
- `False`：只要值重复出现了，就被视为重复值，一个都不保留.
### 行抽样

欲对数据框进行抽样，可以使用`sample()`方法，它默认对行进行采样. 此方法接受如下参数：
- `n`或`frac`：抽样的条数或者比例，都不指定则只抽一行.
- `replace`：是否是有放回抽样，默认为`False`，即每一行只会在抽样里出现一次.
- `weights`：抽样权重，默认为均等权重，可以传入列名字符串作为权重列考虑.
- `axis`：抽样轴，默认抽取行，一般不会抽取列.

### 设置index

对已有数据框，如果想要从已有的列中创建索引，使用`set_index()`方法，它接受一个列名字符串或其列表，将其设置为index或多重index.
- 默认情况下，此方法会删去数据框中作为index的列，但如果打算保存这一列，可以指定参数`drop`为`False`.
- 默认情况下，此方法会删去现有index，但如果只是打算将新列添加到已有index构成多重index，可以指定参数`append`为`True`.

如果打算将现有的index加入到变量列，使用`reset_index()`方法，它将现有的index作为列`index`加入到DataFrame，并且为DataFrame重新指定了简单整数index.
- 默认情况下，此方法会将现有index作为列加入数据框，如果只是打算重新设置简单的index，可以指定参数`drop`为`True`.
- 默认情况下，此方法会移除全部index，如果只打算移除某一层，可以指定参数`level`为对应的index层级.

如果想要将已有列表设置为index（而不是DataFrame的现有列），可以直接通过DataFrame的index属性赋值. 可以用`pd.Index()`创建一个index，其中第一个参数为index列表，参数`name`指定index的名字.

### 包含检查

`isin()`函数可以检查Series或者DataFrame的一个行取值是否在一定范围内，并返回一个同型Bool容器.

对DataFrame而言，可以用两种形式传递范围列表，一种是传入一个列表，这时对比是逐元素的，与元素所在的列无关；另一种是传入一个字典，字典的键是列名，值是该列的范围列表，这时对比是逐列的，每一列有各自的取值范围. 无论哪种传入形式，返回的都是一个Bool DataFrame，如果想要找到每一列都处于范围的行，可以对此Bool DataFrame使用`all(1)`方法.

对于多重索引，此函数还可以检查索引的层级，此时`isin()`方法的应用对象是数据框的`index`属性. 可以用传入`level`参数指定具体某一级的取值范围，也可以传入一个二元组构成的列表，每个二元组第一项是索引层级，第二项是该层索引的取值范围.